<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IR Graphs</title>
    <!-- Link to our stylesheet -->
    <link href="{{ url_for('static', path='/style.css') }}" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />
    <!-- Keep icons for now, but remove fonts if strictly offline. The user asked to fix CORS for fonts specifically. -->
    <style>
        /* Fallback for icons if they fail to load */
        .material-symbols-rounded {
            font-family: 'Material Symbols Rounded';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Side Panel -->
        <aside class="side-panel">
            <header class="panel-header">
                <h1>IR Graph Editor</h1>
                <p class="subtitle">v2.1</p>
            </header>

            <div class="panel-content">

                <!-- View Options -->
                <section class="card">
                    <div class="card-header">
                        <span class="material-symbols-rounded icon">visibility</span>
                        <h2>View Options</h2>
                    </div>
                    <form id="view-options-form">
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggle-node-border" name="node-border">
                            <label for="toggle-node-border">Show Node Borders</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="toggle-text-below" name="text-below">
                            <label for="toggle-text-below">Text Below Node</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="toggle-edge-desc" name="edge-desc" checked>
                            <label for="toggle-edge-desc">Show Edge Descriptions</label>
                        </div>

                        <div class="form-group" style="margin-top: 10px;">
                            <label for="edge-mode-select"
                                style="display: block; margin-bottom: 5px; font-weight: 500;">Edge Mode</label>
                            <select id="edge-mode-select" name="edge-mode"
                                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
                                <option value="bezier">Curved (Default)</option>
                                <option value="straight">Straight</option>
                                <option value="taxi">Right Angles</option>
                                <option value="unbundled-bezier">Avoid Overlap</option>
                            </select>
                        </div>
                    </form>
                </section>

                <!-- Form to add a new node -->
                <section class="card">
                    <div class="card-header">
                        <span class="material-symbols-rounded icon">person_add</span>
                        <h2>Add Node</h2>
                    </div>
                    <form id="add-node-form">
                        <div class="form-group">
                            <label for="node-name">Name</label>
                            <input type="text" id="node-name" name="node-name" required placeholder="Node Name">
                        </div>
                        <div class="form-group">
                            <label for="node-category">Category</label>
                            <select id="node-category" name="node-category"></select>
                        </div>
                        <div class="form-group">
                            <label for="node-description">Description</label>
                            <textarea id="node-description" name="node-description" placeholder="Optional description"
                                rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-secondary">Add Node</button>
                    </form>
                </section>

                <!-- Form to create a new graph -->
                <section class="card">
                    <div class="card-header">
                        <span class="material-symbols-rounded icon">add_circle</span>
                        <h2>Manage Graph</h2>
                    </div>
                    <form id="create-graph-form">
                        <div class="form-group">
                            <label for="graph-name">Name</label>
                            <input type="text" id="graph-name" name="graph-name" required
                                placeholder="My Amazing Graph">
                        </div>
                        <button type="submit" class="btn btn-primary">Create New Graph</button>
                    </form>
                    <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                        <button id="delete-graph-btn" class="btn btn-danger"
                            style="width: 100%; background-color: #ef4444; color: white;">Delete Current Graph</button>
                    </div>
                </section>

                <!-- Actions -->
                <section class="card actions-card">
                    <h2>Actions</h2>
                    <div class="action-buttons">
                        <form id="save-graphs-form">
                            <button type="submit" class="btn btn-outline" title="Save all graphs to JSON">
                                <span class="material-symbols-rounded">save</span> Save Data
                            </button>
                        </form>
                        <form id="export-graph-png-form">
                            <button type="submit" class="btn btn-outline" title="Export current view as PNG">
                                <span class="material-symbols-rounded">image</span> Export PNG
                            </button>
                        </form>
                    </div>
                </section>
            </div>

            <footer class="panel-footer">
                <small>&copy; 2026 IR Graph</small>
            </footer>
        </aside>

        <!-- Main Content -->
        <main class="content-area">
            <header class="top-bar">
                <div class="graph-info">
                    <h2 id="main-graph-title">Select a Graph</h2>
                    <span class="badge" id="current-graph-id" title="Current Graph ID">ID: -</span>
                </div>
                <div class="graph-controls">
                    <div class="button-group">
                        <button id="btn-undo" class="btn btn-outline" title="Undo (Ctrl+Z)">
                            <span class="material-symbols-rounded">undo</span>
                        </button>
                        <button id="btn-redo" class="btn btn-outline" title="Redo (Ctrl+Y)">
                            <span class="material-symbols-rounded">redo</span>
                        </button>
                    </div>
                    <label for="graph-selector" class="sr-only">Select Graph</label>
                    <div class="select-wrapper">
                        <select id="graph-selector" name="graph-selector"></select>
                    </div>
                </div>
            </header>

            <div id="cy" class="graph-canvas">
                <div class="empty-state">
                    <span class="material-symbols-rounded">hub</span>
                    <p>Select or create a graph to begin</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Node Modal -->
    <div id="edit-node-modal" class="modal-overlay" style="display: none;">
        <div class="modal card">
            <div class="card-header">
                <span class="material-symbols-rounded icon">edit</span>
                <h2>Edit Node</h2>
            </div>
            <form id="edit-node-form">
                <input type="hidden" id="edit-node-original-name">
                <div class="form-group">
                    <label for="edit-node-name">Name</label>
                    <input type="text" id="edit-node-name" name="edit-node-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-node-category">Category</label>
                    <select id="edit-node-category" name="edit-node-category"></select>
                </div>
                <div class="form-group">
                    <label for="edit-node-description">Description</label>
                    <textarea id="edit-node-description" name="edit-node-description" rows="3"></textarea>
                </div>
                <div class="modal-actions"
                    style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button type="button" id="cancel-edit-node" class="btn btn-outline">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Edge Modal -->
    <div id="edit-edge-modal" class="modal-overlay" style="display: none;">
        <div class="modal card">
            <div class="card-header">
                <span class="material-symbols-rounded icon">edit</span>
                <h2>Edit Connection</h2>
            </div>
            <form id="edit-edge-form">
                <input type="hidden" id="edit-edge-source">
                <input type="hidden" id="edit-edge-target">
                <div class="form-group">
                    <label for="edit-edge-description">Description</label>
                    <input type="text" id="edit-edge-description" name="edit-edge-description"
                        placeholder="e.g. Lateral Movement">
                </div>
                <div class="form-group">
                    <label for="edit-edge-style">Style</label>
                    <select id="edit-edge-style" name="edit-edge-style"
                        style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
                        <option value="solid">Solid</option>
                        <option value="dotted">Dotted</option>
                    </select>
                </div>
                <div class="modal-actions"
                    style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button type="button" id="cancel-edit-edge" class="btn btn-outline">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Dialog Modal -->
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal card">
            <div class="card-header">
                <span class="material-symbols-rounded icon" style="color: var(--danger);">warning</span>
                <h2>Confirm Action</h2>
            </div>
            <p id="confirm-modal-message" style="margin-bottom: 20px; color: var(--text-main);">Are you sure?</p>
            <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" id="cancel-confirm" class="btn btn-outline">Cancel</button>
                <button type="button" id="ok-confirm" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Load the Cytoscape.js library from local static file -->
    <script src="{{ url_for('static', path='/cytoscape.min.js') }}"></script>
    <!-- Load Cytoscape Extensions -->
    <script src="{{ url_for('static', path='/lodash.min.js') }}"></script>
    <script src="{{ url_for('static', path='/cytoscape-edgehandles.js') }}"></script>
    <script src="{{ url_for('static', path='/cytoscape-cxtmenu.js') }}"></script>
    <script src="{{ url_for('static', path='/cytoscape-undo-redo.js') }}"></script>
    <!-- Load our custom script -->
    <script src="{{ url_for('static', path='/script.js') }}"></script>
</body>

</html>